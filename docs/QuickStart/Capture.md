# capture.js

`capture.js` は一括ダウンロードスクリプトを生成するためのスクリプトである。

ブラウザ上で動作する JavaScript はローカルファイルへの書き込みができない。
そこで `capture.js` はシェルスクリプトを生成し、それをユーザーに実行してもらう。
シェルスクリプトは一連の [cURL][] コマンドを実行、画像ファイルとして保存する。
なお `cURL` コマンドは最近の基本ソフトウエア(OS)に標準収録されているものである。

[cURL]: https://curl.se

> [!CAUTION]
> 以前、開発者コンソールでの[コード実行は危険](./index.md#devtools)と書いた。
> しかし「ターミナル」でのスクリプト実行は **もっとあぶない** のである。
>
> 上述したようにブラウザは独自の安全装置を備えている。
> 一方、ターミナルは本質的にあらゆる操作を実行するためのものである。
> つまり、ファイル消失やデータ漏洩といった潜在的な危険性を伴っている &mdash;
> 意図的(マルウエア)か否か(バグ)に関わらず...
>
> これは `capture.js` が生成するスクリプトも例外ではない
> (もちろん、簡単な動作確認はしているが)
> そして、ファイル消失対策にはもちろん _Time Machine_ バックアップである。

## in the DevTools

まず、第一段階の舞台はブラウザの開発者コンソールである。

1. 単一期間のデータ回収完了後 [capture.js](../../src/capture.js)
   を開発者コンソールに入力、実行する:  
   こちらも同一ドメインであれば任意のページで動作するはずだ。
2. ページ最上部の _Capture_ ボタンを押す:  
   生成されたスクリプトがクリップボードへコピーされる。

## in the Terminal

第二段階は「ターミナル」の出番である。
開発者コンソールのメッセージを参考にターミナルへコマンドを入力していこう。

1. macOS 標準アプリケーションの「ターミナル」を開く
2. 既存ファイルの上書きを避けるため作業フォルダを作成・移動する:  
   `mkdir -p ~/Downloads/Cabbage && cd ~/Downloads/Cabbage`
3. クリップボードの内容をファイルヘペースト: 例えば...  
   `pbpaste > ./2024-12.sh`
4. 保存したスクリプトにユーザー自身(u)への実行権限(x)を与える(+):  
   `chmod u+x ./2024-12.sh`
5. ざっくりスクリプトを眺めてみる:  
   `cat ./2024-12.sh`
6. スクリプトを実行する: `./` が必要なことに注意  
   `./2024-12.sh`
7. ターミナルにダウンロードの進捗状況が表示される
8. _Completed..._ に続いてプロンプトが表示されたらスクリプト終了
9. 当面ターミナルが不要なら `Control+D` を押下後、ウインドウを終了する:  
   `Control+D` の代わりに `exit` [Return] でもよい。
10. `cabbage.example.jp` 形式フォルダの成果物を確認する
    - `articleid-sectionid` 形式サブフォルダ内の画像を確認:  
      オリジナルの 4K 画質ではなくあくまで **プレビュー品質** である。
    - `cabbage.tsv` は [動画回収](./Downloads.md) にて使用する
      [タブ区切り形式][TSV] データである
    - 画像ではなくエラーページが収集されていることがある。
      この場合、[内部領域を消去](./Sweep.md)し[収集](./Walk.md)からやり直す。

[TSV]: https://ja.wikipedia.org/wiki/Tab-Separated_Values

> [!WARNING]  
> シェルスクリプトはダブルクリック操作で実行される恐れがある。
> 内容を確認するときは注意が必要だ。

> [!TIP]
> 実行中のプロクラムを中断するには `Control+C` を押下する。
> ただし、この操作はデータに不整合を生じさせる可能性もある。

## Cookie

Cookie とはサーバーとブラウザ間で受け渡される小さなデータのことである。

例えるなら、食券制の外食店で発行される引換券のようなものだろう。
つまり、店はこの番号をキーとしてお客様を識別するのである。
サーバーも同様に、提示された Cookie からユーザーを識別しているそうだ
(実際には URL の一部に含まれる認証情報と併用されることもある)

そして Cookie には **消費期限** がある。
要するに時間の経った引換券はあまり信用ならない、ということなのだろう。

本スクリプトでも `cURL` へ Cookie 関連のオプションを追加している。
しかし、それでもサーバーからエラーが返されてしまうことがある。
その場合、Cookie や URL の消費期限切れを疑ってみるのもよいだろう。
サイトによっては、消費期限が一時間ということもあるそうだ。
収集したデータは **熱いうちにお召し上がりになれ** ということらしい。

本章の操作で単一区間の文字情報および一連の画像を収集できた。
次の区間に進む前に、ブラウザの内部領域を一度[クリア](./Sweep.md)しておく。
